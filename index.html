<!DOCTYPE html>
<html>
<head>
    <title>HTML Audio Streamer</title>
</head>
<body>
    <center>
        <img src="stream.mjpg" width="640" height="480">
        
        <button id="record">Record</button>
    </center>
    <!-- <center><input type="file" accept="audio/*" capture id="recorder"></center>
    <center><audio id="player" controls></audio></center> -->

    <script>
        const stopButton = document.getElementById('record');

        const bufferSize = 8192;
        
        const handleSuccess = useAudioProc;

        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(handleSuccess);

        function useAudioProc(stream) {
            let started = false;
            const context = new AudioContext();
            const source = context.createMediaStreamSource(stream);
            const processor = context.createScriptProcessor(bufferSize, 1, 1);
            source.connect(processor);
            processor.connect(context.destination);

            const buf = [];

            stopButton.addEventListener('click', function() {
                if (!started) {
                    started = true;
                    stopButton.textContent = "Stop";
                } else {
                    console.log(`Sampling rate: ${context.sampleRate}`);

                    let body = {
                        buf,
                        sampleRate: context.sampleRate,
                        bufferSize
                    }
                    fetch('/audio', {
                        method: 'post',
                        body: JSON.stringify(body)
                    });

                    buf.length = 0;
                    stopButton.textContent = "Start";
                    started = false;
                }
            });

            processor.onaudioprocess = function(e) {
                if (started) buf.push(...e.inputBuffer.getChannelData(0));
            }
        }
    </script>
</body>
</html>
